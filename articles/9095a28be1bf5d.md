---
title: "NestJSã§JWTã‚’ä½¿ã£ãŸèªè¨¼ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ•µï¸â€â™€ï¸"
type: "tech"
topics: ["typescript", "jwt", "nestjs", "passport"]
published: true
---

# ã“ã®è¨˜äº‹ã«ã¤ã„ã¦

[NestJS](https://nestjs.com/)ã§ã€[JWT](https://ja.wikipedia.org/wiki/JSON_Web_Token)ã‚’ä½¿ã£ãŸèªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦è¡Œãã¾ã™ğŸ’ª

**â€» åŸºæœ¬çš„ã«ä»¥ä¸‹ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ãŒã€ä¸€éƒ¨å®Ÿç”¨çš„ãªãƒ¢ãƒã«è¿‘ã¥ã‘ãŸå½¢ã§å†…å®¹ã‚’å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚**

https://docs.nestjs.com/security/authentication

# å¿…è¦ãªnpmãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

:::message
æ—¢ã«`nest`ã‚³ãƒãƒ³ãƒ‰ãªã©ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã²ãªå‹ã‚’ç”Ÿæˆã—ã¦ã„ã‚‹äº‹ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
:::

```shell
$ npm i --save @nestjs/passport passport passport-local @nestjs/jwt passport-jwt
$ npm i --save-dev @types/passport-local @types/passport-jwt
```

[passport](http://www.passportjs.org/)ã¯ã€nodejsã§ã‚ˆãä½¿ã‚ã‚Œã¦ã„ã‚‹èªè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚
[passport-local](http://www.passportjs.org/packages/passport-local/)ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã§ãã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚
[passport-jwt](http://www.passportjs.org/packages/passport-jwt/)ã¯ã€[JWT](https://ja.wikipedia.org/wiki/JSON_Web_Token)ã®æ¤œè¨¼ãªã©ã‚’ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚

**â€» passportã¯ã€passport-localã‚„passport-jwtãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æˆ¦ç•¥( strategy )ã¨è¨€ã†ã®ã§ã€è¦šãˆã¦ãŠã„ãŸæ–¹ãŒè‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚**

>Passport recognizes that each application has unique authentication requirements. Authentication mechanisms, known as strategies, are packaged as individual modules. Applications can choose which strategies to employ, without creating unnecessary dependencies.

ã¾ãŸä»–ã®èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ã„ãŸã„å ´åˆã¯ã€Passportã®ã‚µã‚¤ãƒˆã‹ã‚‰Strategyã‚’æ¤œç´¢ã§ãã¾ã™ğŸ‘¨â€ğŸ’»

http://www.passportjs.org/packages/

# èªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹

:::message:alert
æ—¢ã«TypeORMã§Userã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å®šç¾©ã—ã¦ã„ã‚‹äº‹ã‚’å‰æã«é€²ã‚ã¦ã„ãã¾ã™ã€‚
ã¾ã ä½œã£ã¦ãªã„å ´åˆã‚„TypeORMä»¥å¤–ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯ã€é©æ™‚å¯¾å¿œã—ã¦ãã ã•ã„ğŸ™
:::

`nest`ã‚³ãƒãƒ³ãƒ‰ã§ã²ãªå‹ã‚’ä½œæˆã—ã¦ã€`local.strategy.ts`ãªã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ä½œæˆã—ã¾ã™ã€‚

```shell
$ # èªè¨¼æ©Ÿèƒ½ã‚’æ‰±ã†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã®ã²ãªå‹ã‚’ä½œæˆ
$ nest g module auth
$ nest g service auth

$ # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ‰±ã†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã®ã²ãªå‹ã‚’ä½œæˆ
$ nest g module users
$ nest g service users

$ # Strategyãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
$ touch src/auth/local.strategy.ts
$ touch src/auth/jwt.strategy.ts
```

æ¬¡ã«ä½œã£ãŸã²ãªå‹ã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ã—ã¦è¡Œãã¾ã™ã€‚

## UsersServiceã®å®Ÿè£…

```ts:users/users.service.ts
import { Repository } from 'typeorm';
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { User } from './user.entity'; // typeormã§å®šç¾©ã—ãŸUserã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

/**
 * @description Useræƒ…å ±ã‚’æ‰±ã†ã‚¯ãƒ©ã‚¹
 */
@Injectable()
export class UsersService {

  constructor(
    @InjectRepository(User)
    private readonly userRepository: Repository<User>
  ) {}

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¸€äººã‚’è¿”ã™
  findOne(username: User['name']): Promise<User | undefined> {
    // typeormã‹ã‚‰DBã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã™ã‚‹
    return this.userRepository.findOne({ where: { name } });
  }
}
```

## UsersModuleã®å®Ÿè£…

```ts:users/users.modules.ts
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from './user.entity'; // typeormã§å®šç¾©ã—ãŸUserã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
import { UsersService } from './users.service'; // ä¸Šè¨˜ã§å®šç¾©ã—ãŸServiceã‚¯ãƒ©ã‚¹

@Module({
  // Userã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’UsersServiceã§ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
  imports: [TypeOrmModule.forFeature([User])], 

  // exportsã™ã‚‹ãŸã‚ã«å¿…è¦ã€‚UsersModuleå†…ã§ä½¿ã†ã®ã«ã‚‚å¿…è¦ã€‚
  providers: [UsersService], 

  // UsersServiceã‚’ä»–ã®ã‚¯ãƒ©ã‚¹ã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
  exports: [UsersService], 
})
export class UsersModule {}
```

## AuthServiceã®å®Ÿè£…

```ts:auth/auth.service.ts
import bcrypt = require('bcrypt');
import { JwtService } from '@nestjs/jwt';
import { Injectable } from '@nestjs/common';
import { User } from 'src/users/user.entity';
import { UsersService } from 'src/users/users.service';

type PasswordOmitUser = Omit<User, 'password'>;

interface JWTPayload  {
  userId: User['id'];
  username: User['name'];
}

/**
 * @description Passportã§ã¯å‡ºæ¥ãªã„èªè¨¼å‡¦ç†ã‚’ã™ã‚‹ã‚¯ãƒ©ã‚¹
 */
@Injectable()
export class AuthService {
  constructor(private jwtService: JwtService, private usersService: UsersService) {}

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼ã™ã‚‹
  async validateUser(name: User['name'], pass: User['password']): Promise<PasswordOmitUser | null> {
    const user = await this.usersService.findOne(name); // DBã‹ã‚‰Userã‚’å–å¾—

    // DBã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹passwordã¯ãƒãƒƒã‚·ãƒ¥åŒ–ã•ã‚Œã¦ã„ã‚‹äº‹ã‚’æƒ³å®šã—ã¦ã„ã‚‹ã®ã§ã€
    // bcryptãªã©ã‚’ä½¿ã£ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’åˆ¤å®šã™ã‚‹
    if (user && bcrypt.compareSync(pass, user.password)) {
      const { password, ...result } = user; // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æƒ…å ±ã‚’å¤–éƒ¨ã«å‡ºã•ãªã„ã‚ˆã†ã«ã™ã‚‹

      return result;
    }

    return null;
  }

  // jwt tokenã‚’è¿”ã™
  async login(user: PasswordOmitUser) {
    // jwtã«ã¤ã‘ã‚‹Payloadæƒ…å ±
    const payload: JwtPayload = { userId: user.id, username: user.name };

    return {
      access_token: this.jwtService.sign(payload),
    };
  }
}
```

## LocalStrategyã®å®Ÿè£…

```ts:auth/local.strategy.ts
// importå…ˆãŒ'passport-jwt'ã§ã¯ç„¡ã„äº‹ã«æ³¨æ„ï¼
import { Strategy as BaseLocalStrategy } from 'passport-local';

import { PassportStrategy } from '@nestjs/passport';
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { AuthService } from './auth.service';
import { User } from 'src/users/user.entity';

type PasswordOmitUser = Omit<User, 'password'>;

/**
 * @description usernameã¨passwordã‚’ä½¿ã£ãŸèªè¨¼å‡¦ç†ã‚’è¡Œã†ã‚¯ãƒ©ã‚¹
 */
@Injectable()
export class LocalStrategy extends PassportStrategy(BaseLocalStrategy) {
  constructor(private authService: AuthService) {
    super();
  }

  // passport-localã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ username ã¨ password ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã§å—ã‘å–ã‚‹
  async validate(name: User['name'], pass: User['password']): Promise<PasswordOmitUser> {
    // èªè¨¼ã—ã¦çµæœã‚’å—ã‘å–ã‚‹
    const user = await this.authService.validateUser(name, pass);

    if (!user) {
      throw new UnauthorizedException(); // èªè¨¼å¤±æ•—
    }

    return user;
  }
}
```

## JwtStrategyã®å®Ÿè£…

```ts:auth/jwt.strategy.ts
// importå…ˆãŒ'passport-local'ã§ã¯ç„¡ã„äº‹ã«æ³¨æ„ï¼
import { ExtractJwt, Strategy as BaseJwtStrategy } from 'passport-jwt'; 

import { Injectable } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { PassportStrategy } from '@nestjs/passport';
import { JwtPayload } from './auth.interface';
import { User } from 'src/users/user.entity';


// Jwtã«ã¤ã„ã¦ã„ã‚‹Payloadæƒ…å ±ã®å‹
interface JWTPayload  {
  userId: User['id'];
  username: User['name'];
}

/**
 * @description JWTã®èªè¨¼å‡¦ç†ã‚’è¡Œã†ã‚¯ãƒ©ã‚¹
 */
@Injectable()
export class JwtStrategy extends PassportStrategy(BaseJwtStrategy) {
  constructor(private readonly configService: ConfigService) {
    super({
      // Authorization bearerã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°ã‚’è¿”ã™
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(), 
      // æœ‰åŠ¹æœŸé–“ã‚’ç„¡è¦–ã™ã‚‹ã‹ã©ã†ã‹
      ignoreExpiration: false,
      // envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç§˜å¯†éµã‚’æ¸¡ã™
      secretOrKey: configService.get<string>('JWT_SECRET_KEY'), 
    });
  }

  // ã“ã“ã§Payloadã‚’ä½¿ã£ãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ã‚’å®Ÿè¡Œã§ãã‚‹
  // Payloadã¯ã€AuthService.login()ã§å®šç¾©ã—ãŸå€¤
  async validate(payload: JWTPayload): Promise<JwtPayload> {
    return { userId: payload.userId, username: payload.username };
  }
}
```

## AuthModuleã®å®Ÿè£…

ä¸Šè¨˜ã§å®Ÿè£…ã—ã¦ããŸã‚¯ãƒ©ã‚¹é”ã‚’`AuthModule`ã§ã¾ã¨ã‚ã¾ã™ã€‚

```ts:auth/auth.module.ts
import { Module } from '@nestjs/common';
import { JwtModule } from '@nestjs/jwt';
import { ConfigService } from '@nestjs/config';
import { PassportModule } from '@nestjs/passport';

import { AuthService } from './auth.service';
import { UsersModule } from 'src/users/users.module';

// Strategyã‚¯ãƒ©ã‚¹
import { JwtStrategy } from './jwt.strategy';
import { LocalStrategy } from './local.strategy';

@Module({
  imports: [
    UsersModule,
    PassportModule,

    // JWTã‚’ä½¿ã†ãŸã‚ã®è¨­å®šã‚’ã—ã¦ã„ã‚‹
    JwtModule.registerAsync({
      useFactory: async (configService: ConfigService) => {
        return {
          // envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç§˜å¯†éµã‚’æ¸¡ã™
          secret: configService.get<string>('JWT_SECRET_KEY'), 
          signOptions: { 
            // æœ‰åŠ¹æœŸé–“ã‚’è¨­å®š
            // æŒ‡å®šã™ã‚‹å€¤ã¯ä»¥ä¸‹ã‚’å‚ç…§
            // https://github.com/vercel/ms
            expiresIn: '1200s' 
          },
        };
      },
      inject: [ConfigService], // useFactoryã§ä½¿ã†ç‚ºã«ConfigServiceã‚’æ³¨å…¥ã™ã‚‹
    }),
  ],
  providers: [AuthService, LocalStrategy, JwtStrategy],
  exports: [AuthService],
})
export class AuthModule {}
```

## AppModuleã®å®Ÿè£…

ãã—ã¦ã€`AuthModule`ã‚’`AppModule`ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã£ã¦ã€èªè¨¼å‡¦ç†ã‚’NestJSã‚¢ãƒ—ãƒªå…¨ä½“ã«çµ„ã¿è¾¼ã‚ã‚‹ã®ã§ã€å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ğŸ‘¨â€ğŸ«

```ts:src/app.module.ts
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { TypeOrmModule } from '@nestjs/typeorm';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { UsersModule } from './users/users.module';
import { AuthModule } from './auth/auth.module';
import { RentalModule } from './rental/rental.module';
import { SellModule } from './sell/sell.module';

@Module({
  imports: [
    TypeOrmModule.forRoot(), // typeormã‚’ä½¿ã†ãŸã‚ã«ä½¿ç”¨
    ConfigModule.forRoot({ // envãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµ„ã¿è¾¼ã‚€ãŸã‚ã«ä½¿ç”¨
      isGlobal: true,
    }),
    AuthModule, // å¿…é ˆï¼ã“ã‚ŒãŒç„¡ã„ã¨èªè¨¼å‡¦ç†ãŒå‹•ã‹ãªã„
  ],
  controllers: [
    AppController // å¾Œè¿°ã™ã‚‹ã‚¯ãƒ©ã‚¹
  ], 
  providers: [AppService],
})
export class AppModule {}
```

ä¸Šè¨˜ã¾ã§å‡ºæ¥ãŸã‚‰ã€`AppController`ã‚’å®šç¾©ã—ã¦å®Ÿéš›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

## AppControllerã®å®Ÿè£…

:::message
ã“ã“ã®éƒ¨åˆ†ã¯`AuthController`ã‚’ç”¨æ„ã—ã¦ã€ãã¡ã‚‰ã®ã‚¯ãƒ©ã‚¹ã«è¨˜è¿°ã—ãŸæ–¹ãŒè‰¯ã„ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ã€‚
:::

```ts:app.controller.ts
import { AuthGuard } from '@nestjs/passport';
import { Controller, Get, Post, Request, UseGuards } from '@nestjs/common';
import { User } from './users/user.entity';
import { AppService } from './app.service';
import { AuthService } from './auth/auth.service';

type PasswordOmitUser = Omit<User, "password">

@Controller()
export class AppController {
  constructor(private readonly authService: AuthService) {}

  @UseGuards(AuthGuard('local')) // passport-localæˆ¦ç•¥ã‚’ä»˜ä¸ã™ã‚‹
  @Post('login') 
  async login(@Request() req: { user: PasswordOmitUser }) {
    // LocalStrategy.validate()ã§èªè¨¼ã—ã¦è¿”ã—ãŸå€¤ãŒreq.userã«å…¥ã£ã¦ã‚‹
    const user = req.user;

    // JwtToken ã‚’è¿”ã™
    return this.authService.login(req.user);
  }

  /**
   * @description JWTèªè¨¼ã‚’ç”¨ã„ãŸã‚µãƒ³ãƒ—ãƒ«API
   */
  @UseGuards(AuthGuard('jwt')) // passport-jwtæˆ¦ç•¥ã‚’ä»˜ä¸ã™ã‚‹
  @Get('profile')
  getProfile(@Request() req: { user: PasswordOmitUser }) {
    // JwtStrategy.validate()ã§èªè¨¼ã—ã¦è¿”ã—ãŸå€¤ãŒreq.userã«å…¥ã£ã¦ã‚‹
    const user = req.user;

    // èªè¨¼ã«æˆåŠŸã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’è¿”ã™
    return req.user;
  }
}
```

# èªè¨¼æ©Ÿèƒ½ã‚’ç¢ºèªã™ã‚‹

ä¸Šè¨˜ã§å®Ÿè£…ã—ãŸèªè¨¼æ©Ÿèƒ½ã‚’ã€`curl`ãªã©ã‚’ä½¿ã£ã¦å®Ÿéš›ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦å‡¦ç†ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚

## ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¿ã‚‹

ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¿ã¾ã™ã€‚

**â€» ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€å„è‡ªã§ç”¨æ„ã—ã¦ãã ã•ã„ã€‚**

```shell:AppController.login()ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã¿ã‚‹
$ curl -X POST http://localhost:3000/login -d '{"username": "john", "password": "changeme"}' -H "Content-Type: application/json"
$ # result -> {"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm... }
```

ä¸Šè¨˜ã®ã‚ˆã†ã«ã€`{ "access_token": "..." }`ã¿ãŸã„ãªå€¤ãŒå¸°ã£ã¦ãã‚Œã°æˆåŠŸã§ã™ğŸ‰

:::message:alert
ã“ã®æ™‚ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¯`{ "username": "...", "password": "..." }`ã¨ãªã£ã¦ã„ã¾ã™ãŒã€
ã“ã‚Œã¯`passport-local`æˆ¦ç•¥ã«ã‚ˆã‚‹ã‚‚ã®ã§ã™ã€‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’å¤‰æ›´ã—ãŸã„å ´åˆã¯ã€`passport-local`ã®è¨­å®šã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
è©³ã—ãã¯ : https://docs.nestjs.com/security/authentication#customize-passport
:::

### å®Ÿéš›ã®å‡¦ç†ã®æµã‚Œ

ãƒ­ã‚°ã‚¤ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ãŸæ™‚ã«ã€ã“ã®è¨˜äº‹ã§æ›¸ã„ã¦æ¥ãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒã©ã®é †ç•ªã§å®Ÿè¡Œã•ã‚Œã‚‹ã‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

#### 1. `AppController.login()`ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹( â€»ãƒ–ãƒ­ãƒƒã‚¯ã®å®Ÿè¡Œã¯ã¾ã  )
ã€€

**ã“ã“ã§ã®æ³¨æ„ã™ã‚‹ã¹ãã¨ã“ã‚ãŒã‚ã‚Šã¾ã™ï¼**
ãã‚Œã¯ã€`login()`ã®ãƒ–ãƒ­ãƒƒã‚¯ã«è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹å‡¦ç†ã¯ã¾ã å®Ÿè¡Œã•ã‚Œãªã„ã¨ã„ã†äº‹ã§ã™ã€‚
ä½•æ•…ãªã‚‰ã€å®Ÿè¡Œã•ã‚Œã‚‹å‰ã«ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®`@UseGuards(AuthGuard('local'))`ã®å‡¦ç†ãŒèµ°ã‚‹ãŸã‚ã§ã™ã€‚

```ts:è©²å½“ã®éƒ¨åˆ†
export class AppController {
  
  /* -- çœç•¥ -- */

  @UseGuards(AuthGuard('local')) // passport-localæˆ¦ç•¥ã‚’ä»˜ä¸ã™ã‚‹
  @Post('login') 
  async login(@Request() req: { user: PasswordOmitUser }) {
    // LocalStrategy.validate()ã§èªè¨¼ã—ã¦è¿”ã—ãŸå€¤ãŒreq.userã«å…¥ã£ã¦ã‚‹
    const user = req.user;

    // JwtToken ã‚’è¿”ã™
    return this.authService.login(req.user);
  }

  /* -- çœç•¥ -- */
}
```

#### 2. `@UseGuards(AuthGuard('local'))`ã«ã‚ˆã£ã¦ã€`LocalStrategy.validate()`ãŒå®Ÿè¡Œã•ã‚Œã‚‹
ã€€
 
**LocalStrategy** ã¯ **BaseLocalStrategy** ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹ãŸã‚ã€`passport-local`ãŒå®Ÿè¡Œã•ã‚Œã‚‹æ™‚ã«ã€`@nestjs/passport`ã«ã‚ˆã£ã¦å†…éƒ¨ã§`LocalStrategy.validate()`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
ãªã®ã§ã€`LocalStrategy.validate()`**ã‚’æ˜ç¤ºçš„ã«å®Ÿè¡Œã—ã¦ã„ã‚‹éƒ¨åˆ†ã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ã¯ã‚ã‚Šã¾ã›ã‚“ã®ã§ã€æ³¨æ„ã—ã¦ãã ã•ã„ã€‚**

```ts:è©²å½“ã®éƒ¨åˆ†
@Injectable()
export class LocalStrategy extends PassportStrategy(BaseLocalStrategy) {
  
  /* -- çœç•¥ -- */
  
  /**
   * @note passport-localã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ username ã¨ password ã‚’å–ã‚‹
   */
  async validate(name: User['name'], pass: User['password']): Promise<PasswordOmitUser> {
    const user = await this.authService.validateUser(name, pass);

    if (!user) {
      throw new UnauthorizedException();
    }

    return user;
  }
}
```

#### 3. `LocalStrategy.validate()`ãŒæˆåŠŸã—ãŸå ´åˆã€`AppController.login()`ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€‚
ã€€

ã“ã“ã§åˆã‚ã¦ã€`AppController.login()`ã®ãƒ–ãƒ­ãƒƒã‚¯å†…ã«è¨˜è¿°ã•ã‚ŒãŸå‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

â€» ã‚‚ã—`LocalStrategy.validate()`ãŒèªè¨¼ã«å¤±æ•—ã—ãŸå ´åˆ(Errorã‚’æŠ•ã’ãŸå ´åˆ)ã¯ã€`AppController.login()`ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚

```ts:è©²å½“ã®éƒ¨åˆ†
async login(@Request() req: { user: PasswordOmitUser }) {
  // LocalStrategy.validate()ã§èªè¨¼ã—ã¦è¿”ã—ãŸå€¤ãŒreq.userã«å…¥ã£ã¦ã‚‹
  const user = req.user;

  // JwtToken ã‚’è¿”ã™
  return this.authService.login(req.user);
}
```

#### 4. `this.authService.login()`ãŒå®Ÿè¡Œã•ã‚Œã‚‹
ã€€

`AuthService.login()`ãŒå®Ÿè¡Œã•ã‚Œã€**JWTã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ**ã—ã¦è¿”ã—ã¾ã™ã€‚

```ts:è©²å½“ã®éƒ¨åˆ†
@Injectable()
export class AuthService {
  
  /* -- çœç•¥ -- */

  /**
   * @description jwt tokenã‚’è¿”ã™
   */
  async login(user: PasswordOmitUser) {
    const payload: JwtPayload = { username: user.name, userId: user.id };

    return {
      access_token: this.jwtService.sign(payload),
    };
  }
}
```

#### 5. ãƒªã‚¯ã‚¨ã‚¹ãƒˆçµæœã¨ã—ã¦`{ "access_token": "..." }`ãŒè¿”ã£ã¦ãã‚‹

```shell:curlã®çµæœ
$ # result -> {"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm... }
```

## JWTã‚’ä½¿ã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã¿ã‚‹

æ¬¡ã«`/login`ã§å–å¾—ã—ãŸJWTã‚’ä½¿ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
`acess_token`ã®å€¤ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«ä»˜ã‘ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã“ã¨ã§ã€JWTèªè¨¼ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚
å®Ÿéš›ã«ã‚„ã£ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```shell:AppController.getProfile()ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã¿ã‚‹
$ curl http://localhost:3000/profile -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm..."
$ # result -> {"userId":1,"username":"john"}
```

ã¡ã‚ƒã‚“ã¨Useræƒ…å ±ãŒå–å¾—å‡ºæ¥ã¦ã„ãŸã‚‰æˆåŠŸã§ã™ğŸŠ

ã‚‚ã—`access_token`ã‚’ä»˜ã‘ã¦ã„ã¦ã‚‚å¤±æ•—ã—ãŸå ´åˆã¯ã€**æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã®ã§ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å†ç”Ÿæˆã—ã¦ã‹ã‚‰åŒã˜ã‚ˆã†ã«ã‚„ã£ã¦ã¿ã‚‹ã¨æˆåŠŸã™ã‚‹ã¨æ€ã„ã¾ã™ã€‚** (ã“ã®è¨˜äº‹ã§ã¯1200ç§’ã‚’æœ‰åŠ¹æœŸé™ã¨ã—ã¦è¨­å®šã—ã¦ã„ã¾ã™ã€‚)

### å®Ÿéš›ã®å‡¦ç†ã®æµã‚Œ

JWTãŒå¿…è¦ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ( ä»Šå›ã¯`/profile` )ã‚’æŠ•ã’ãŸæ™‚ã«ã€ã“ã®è¨˜äº‹ã§æ›¸ã„ã¦æ¥ãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒã©ã®é †ç•ªã§å®Ÿè¡Œã•ã‚Œã‚‹ã‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

#### 1. `AppController.getProfile()`ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹( â€»ãƒ–ãƒ­ãƒƒã‚¯ã®å®Ÿè¡Œã¯ã¾ã  )
ã€€

**ã“ã“ã§ã‚‚** `/login` **ã®æ™‚ã¨åŒã˜ã‚ˆã†ã«ã€** `AppController.getProfile()` **ã¯ã¾ã å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚** 
ä»£ã‚ã‚Šã«ã€ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã® `@UseGuards(AuthGuard('jwt'))` ã®éƒ¨åˆ†ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```ts:è©²å½“ã®éƒ¨åˆ†
@Controller()
export class AppController {
  
  /* -- çœç•¥ -- */

  /**
   * @description JWTèªè¨¼ã‚’ç”¨ã„ãŸã‚µãƒ³ãƒ—ãƒ«API
   */
  @UseGuards(AuthGuard('jwt')) // passport-jwtæˆ¦ç•¥ã‚’ä»˜ä¸ã™ã‚‹
  @Get('profile')
  getProfile(@Request() req: { user: PasswordOmitUser }) {
    // JwtStrategy.validate()ã§èªè¨¼ã—ã¦è¿”ã—ãŸå€¤ãŒreq.userã«å…¥ã£ã¦ã‚‹
    const user = req.user;

    // èªè¨¼ã«æˆåŠŸã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’è¿”ã™
    return req.user;
  }
}
```

#### 2. `@UseGuards(AuthGuard('jwt'))`ã«ã‚ˆã£ã¦ã€`JwtStrategy.validate()`ãŒå®Ÿè¡Œã•ã‚Œã‚‹
ã€€

ã“ã“ã‚‚ `LocalStrategy` ã¨ã»ã¨ã‚“ã©åŒã˜ã§ã™ã€‚
**JwtStrategy** ã¯ã€ **BaseJwtStrategy** ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹ãŸã‚ã€`passport-jwt`ãŒå®Ÿè¡Œã•ã‚Œã‚‹æ™‚ã«ã€`@nestjs/passport`ã«ã‚ˆã£ã¦å†…éƒ¨ã§`JwtStrategy.validate()`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
ãªã®ã§ã€**`JwtStrategy.validate()`ã‚’æ˜ç¤ºçš„ã«å®Ÿè¡Œã—ã¦ã„ã‚‹éƒ¨åˆ†ã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ã¯ã‚ã‚Šã¾ã›ã‚“ã®ã§ã€æ³¨æ„ã—ã¦ãã ã•ã„ã€‚**

```ts:è©²å½“ã®éƒ¨åˆ†
@Injectable()
export class JwtStrategy extends PassportStrategy(BaseJwtStrategy) {

  /* -- çœç•¥ -- */
 
  // ã“ã“ã§Payloadã‚’ä½¿ã£ãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ã‚’å®Ÿè¡Œã§ãã‚‹
  // Payloadã¯ã€AuthService.login()ã§å®šç¾©ã—ãŸå€¤
  async validate(payload: JWTPayload): Promise<JwtPayload> {
    return { userId: payload.userId, username: payload.username };
  }
}
```

#### 3. `JwtStrategy.validate()`ãŒæˆåŠŸã—ãŸå ´åˆã€`AppController.getProfile()`ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€‚
ã€€

ã“ã“ã§åˆã‚ã¦ã€`AppController.getProfile()`ã®ãƒ–ãƒ­ãƒƒã‚¯å†…ã«è¨˜è¿°ã•ã‚ŒãŸå‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```ts:è©²å½“ã®éƒ¨åˆ†
getProfile(@Request() req: { user: PasswordOmitUser }) {
  // JwtStrategy.validate()ã§èªè¨¼ã—ã¦è¿”ã—ãŸå€¤ãŒreq.userã«å…¥ã£ã¦ã‚‹
  const user = req.user;

  // èªè¨¼ã«æˆåŠŸã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’è¿”ã™
  return req.user;
}
```

#### 4. ãƒªã‚¯ã‚¨ã‚¹ãƒˆçµæœã¨ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¿”ã£ã¦ãã‚‹

```shell:curlã®çµæœ(/profile)
$ # result -> {"userId":1,"username":"john"}
```


### JWTã«å¤±æ•—ã—ãŸæ™‚

å› ã¿ã«ã€ã‚‚ã—èªè¨¼ã«å¤±æ•—ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```shell:ã‚ã–ã¨access_tokenã‚’ã¤ã‘ãšã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦è¦‹ã‚‹
$ curl http://localhost:3000/profile
$ # result -> {"statusCode":401,"message":"Unauthorized"}
```

ä¸Šè¨˜ã‚ˆã‚Šã€ã¡ã‚ƒã‚“ã¨èªè¨¼ãŒåŠ¹ã„ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã­ğŸ”


# çµ‚ã‚ã‚Š

ã“ã‚Œã§èªè¨¼å‡¦ç†ã‚’ä»˜ã‘ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã—ãŸã€‚

ã“ã‚Œã‹ã‚‰å…ˆã¯ã€èªè¨¼ã‚’ä»˜ã‘ãŸã„ãƒ¡ã‚½ãƒƒãƒ‰ã«`@UseGuards(AuthGuard('jwt'))`ã‚’ä»˜ã‘ã¦ã‚ã’ã‚‹ã‹ã€ä»¥ä¸‹ã®ã‚ˆã†ã«Controllerã«ã¤ã‘ã‚‹äº‹ã§ã€ãã®Controllerå…¨ä½“ã«é©ç”¨ã™ã‚‹ã“ã¨ã‚‚å‡ºæ¥ã¾ã™ã€‚

```ts:å…¨ä½“ã«jwtèªè¨¼ã‚’é©ç”¨ã™ã‚‹
import { AuthGuard } from '@nestjs/passport';
import { UseGuards, Controller } from '@nestjs/common';

@Controller("sample")
@UseGuards(AuthGuard('jwt')) // ã“ã“ã«è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€Controllerå…¨ä½“ã«jwtèªè¨¼ã‚’é©ç”¨ã™ã‚‹
export class SampleController {
  /* -- çœç•¥ -- */
}
```

ä»¥ä¸Šã§ã€è§£èª¬çµ‚äº†ã§ã™ã€‚ãŠç–²ã‚Œã•ã¾ã§ã—ãŸğŸ™Œ

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã™ã‚‹æ–¹æ³•

å‚è€ƒã—ãŸ[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.nestjs.com/security/authentication)ã‚ˆã‚Šä»¥ä¸‹ã‚’å¼•ç”¨ã€‚

>Manage authenticated state (by issuing a portable token, such as a JWT, or creating an Express session)

ã©ã†ã‚„ã‚‰ä»Šå›ç´¹ä»‹ã—ãŸ`JWT`ã‚’ä½¿ã†æ–¹æ³•ã®ä»–ã«ã€[express-session](https://github.com/expressjs/session)ã‚’ä½¿ã†æ–¹æ³•ãŒã‚ã‚‹ã‚‰ã—ã„ã§ã™ã€‚[express-session](https://github.com/expressjs/session)ã®è¨­å®šæ–¹æ³•ãªã©ã¯ã€ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«å®Ÿè£…ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚[fastify-secure-session](https://github.com/fastify/fastify-secure-session)ã«ã‚ˆã‚‹è¨­å®šæ–¹æ³•ã‚‚è¼‰ã£ã¦ã„ã‚‹ã®ã§ã€ãã¡ã‚‰ã‚’ä½¿ã†äº‹ã‚‚å‡ºæ¥ã‚‹ã‚ˆã†ã§ã™ã€‚

https://docs.nestjs.com/techniques/session

ã“ã“ã‚‰è¾ºã®å®Ÿè£…ã¯ã€çŸ¥è¦‹ãŒã¾ã¨ã¾ã£ãŸã‚‰åˆ¥è¨˜äº‹ã«ã—ã¦å…±æœ‰ã—ãŸã„ã¨æ€ã„ã¾ã™ğŸŒï¸â€â™‚ï¸


# JWTã®éµç”Ÿæˆã«ã¤ã„ã¦ğŸ”‘

:::message
ç§ãŒç„¡çŸ¥ãªã ã‘ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ãŒã€ã‚‚ã—ã‹ã—ãŸã‚‰çŸ¥ã‚‰ãªã„äººãŒå±…ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã®ã§å…±æœ‰ã—ã¦ãŠãã¾ã™ğŸ™ æ³¨æ„ã¨ã—ã¦ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«é–“é•ã£ã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã®ã§ã€ã‚ãã¾ã§å‚è€ƒç¨‹åº¦ã«ã—ãŸæ–¹ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚
ã‚ˆã‚Šè‰¯ã„æ–¹æ³•ã‚’çŸ¥ã£ã¦ã„ã‚‹æ–¹ã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆãªã©ã§æ•™ãˆã¦é ‚ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ğŸ™‡â€â™‚ï¸
:::

ä»Šå›ã®å®Ÿè£…ã§ã¯ã€[@nestjs/config](https://docs.nestjs.com/techniques/configuration)ã‚’ä½¿ã£ã¦`envãƒ•ã‚¡ã‚¤ãƒ«`ä¸Šã«ã‚ã‚‹ç§˜å¯†éµã‚’ä½¿ã£ãŸã®ã§ã™ãŒã€**ãã®ç§˜å¯†éµã®ä½œã‚Šæ–¹ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚**

ã¾ãšã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ç§˜å¯†éµã¨å…¬é–‹éµã‚’ä½œæˆã—ã¾ã™ã€‚

```shell:éµã®ä½œæˆ
$ ssh-keygen -t rsa -b 4096 -m pem -f ä»»æ„ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ãƒ‘ã‚¹
$ # ä¾‹ : ssh-keygen -t rsa -b 4096 -m pem -f /nest-app/.settings/id_rsa
```

ã™ã‚‹ã¨ã€`-f`ã§æŒ‡å®šã—ãŸå ´æ‰€ã«éµãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºæ¥ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚( æŒ‡å®šã—ã¦ãªã‘ã‚Œã°`.ssh`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚) ã—ã‹ã—ã€å…¬é–‹éµãƒ•ã‚¡ã‚¤ãƒ«(`.pubãƒ•ã‚¡ã‚¤ãƒ«`)ã®æ–¹ãŒPEMã¨ã—ã¦å‡ºåŠ›ã•ã‚Œã¦ãªã‹ã£ãŸã®ã§ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦PEMã«å¤‰æ›ã—ã¾ã™ã€‚

```shell:å…¬é–‹éµã‚’PEMã«å¤‰æ›
$ ssh-keygen -f å…¬é–‹éµãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ‘ã‚¹ -e -m pem > æ–°ã—ãä½œã‚‹PEMãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
$ # ä¾‹ : ssh-keygen -f id_rsa.pub -e -m pem > id_rsa.pem.pub
```

ãã—ã¦ã€å‡ºæ¥ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’`envãƒ•ã‚¡ã‚¤ãƒ«`ã«ã‚³ãƒ”ãƒšã—ã¾ã™ã€‚
ã“ã“ã§ã®æ³¨æ„ã¨ã—ã¦ã€**æ”¹è¡ŒãŒåæ˜ ã•ã‚Œãªã„ã®ã§ã€`\n`ã‚’ç”¨ã„ã¦æ”¹è¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚**

```env:.env
JWT_PUBLIC_KEY="-----BEGIN RSA PUBLIC KEY-----\n ... \n-----END RSA PUBLIC KEY-----"
JWT_SECRET_KEY="-----BEGIN RSA PRIVATE KEY-----\n ... \n-----END RSA PRIVATE KEY-----"
```

ã‚³ãƒ”ãƒšãŒå‡ºæ¥ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦éµæƒ…å ±ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```ts:.envã‹ã‚‰ç§˜å¯†éµã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹
const secret_key = configService.get<string>('JWT_SECRET_KEY');
```

[@nestjs/config](https://docs.nestjs.com/techniques/configuration)ã®è©³ã—ã„ä½¿ã„æ–¹ã¯ã€ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒ©ãƒƒãƒ—ã‚’å‚è€ƒã«ã—ã¦ä¸‹ã•ã„ã€‚

https://zenn.dev/uttk/scraps/5169d2bb2e3d767533f3#comment-65d278330ab6d7a86627

**å‚è€ƒã«ã—ãŸè¨˜äº‹**

https://qiita.com/sa9ra4ma/items/7e8bb9e4877249ff2001

https://qiita.com/kunichiko/items/12cbccaadcbf41c72735