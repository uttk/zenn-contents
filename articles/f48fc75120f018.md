---
title: "Next.jsã¨Firebaseã§Cookieã‚’ä½¿ã£ãŸèªè¨¼å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ†"
type: "tech"
topics: ["firebase", "nextjs", "typescript"]
published: true
---

# ã“ã®è¨˜äº‹ã«ã¤ã„ã¦

[Firebase Authentication](https://firebase.google.com/docs/auth?hl=ja)ã¨ Next.js ã®[getServerSideProps()](https://nextjs.org/docs/basic-features/data-fetching#getserversideprops-server-side-rendering)ã‚’ä½¿ã£ã¦ã€Cookie ã‚’ä½¿ã£ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†æ–¹æ³•ã‚’ã€ã“ã®å ´ã‚’å€Ÿã‚Šã¦å…±æœ‰ã—ãŸã„ã¨æ€ã„ã¾ã™ ğŸ’ª

ã¾ãŸã€ã“ã®è¨˜äº‹ã®å†…å®¹ã¯åŸºæœ¬çš„ã«ä»¥ä¸‹ã®è¨˜äº‹ã®å†…å®¹ã‚’è¸è¥²ã—ãŸã‚‚ã®ã¨ãªã£ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€å†…å®¹ã‚„ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«å¼•ç”¨ãªã©ãŒå«ã¾ã‚Œã¾ã™ã®ã§ã€äºˆã‚ã”äº†æ‰¿ãã ã•ã„ ğŸ™‡â€â™‚ï¸

https://firebase.google.com/docs/auth/admin/manage-cookies?hl=ja

ãã‚Œã§ã¯è¡Œãã¾ã—ã‚‡ã† ğŸ›´

# ç’°å¢ƒæ§‹ç¯‰

:::message
ã“ã®è¨˜äº‹ã§ã¯ Firebase ã®ç’°å¢ƒæ§‹ç¯‰ã«ã¤ã„ã¦ã¯è§£èª¬ã—ã¾ã›ã‚“ã€‚
æ§‹ç¯‰æ–¹æ³•ãŒçŸ¥ã‚ŠãŸã„æ–¹ã¯ã€ä»¥ä¸‹ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦é ‚ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚

- [Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¤ã„ã¦ç†è§£ã™ã‚‹](https://firebase.google.com/docs/projects/learn-more?hl=ja)
- [Firebase ã‚’ JavaScript ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ ã™ã‚‹](https://firebase.google.com/docs/web/setup?hl=ja)
- [JavaScript ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ Firebase èªè¨¼ã‚’è¡Œã†](https://firebase.google.com/docs/auth/web/password-auth?hl=ja)
  :::

ã¾ãšåˆã‚ã«ã€[create-next-app](https://nextjs.org/docs/api-reference/create-next-app)ã‚’ä½¿ã£ã¦é››å½¢ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®æ™‚ã€`--typescript`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†ã¨ TypeScript ã®é››å½¢ã‚’ä½œæˆã§ãã¾ã™ã®ã§ã€ãã‚Œã‚’ä½¿ã£ã¦ä½œæˆã—ã¾ã™ ğŸ‘‡

```shell:é››å½¢ã‚’ä½œæˆã™ã‚‹
$> npx create-next-app --typescript
```

é››å½¢ãŒä½œæˆã§ãã¾ã—ãŸã‚‰ã€ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«å…¥ã‚Šã€å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã—ã‚‡ã† ğŸ‘‡

```shell:å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$> yarn add nookies firebase-admin firebase@9.0.0
```

ã¡ãªã¿ã«ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è©³ç´°ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ ğŸ‘‡

- **firebase** : Firebase ã® SDKã€‚èªè¨¼å‡¦ç†ã‚’è¡Œã†ã®ã«ä½¿ã†ã€‚
- **firebase-admin** : ç®¡ç†è€…ç”¨ã® SDKã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID ã®æ¤œè¨¼ãªã©ã«ä½¿ã†ã€‚
- **nookies** : Cookie ã‚’æ‰±ã„ã‚„ã™ãã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚

`firebase`ã«ã¤ã„ã¦ã¯ã€[Tree Shaking](https://developer.mozilla.org/ja/docs/Glossary/Tree_shaking)ã‚’ä½¿ã†ãŸã‚`@9.0.0`ã‚’ä»˜ã‘ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™ã€‚è©³ã—ã„äº‹ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ ğŸ‘‡

https://firebase.google.com/docs/web/modular-upgrade

ä¸Šè¨˜ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã—ãŸã‚‰ã€æ¬¡ã¯ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ ğŸ›¶

# èªè¨¼å‡¦ç†ã‚’è¡Œã†é–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹

ã¾ãšã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆå´ã®èªè¨¼å‡¦ç†ã‚’è¡Œã†é–¢æ•°ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ ğŸ‘‡

```ts:./utils.ts
import type { FirebaseApp } from "firebase/app";
import type { Auth as FirebaseAuth } from "firebase/auth";

import { getApps, initializeApp } from "firebase/app";
import { getAuth, signInWithEmailAndPassword } from "firebase/auth";

/**
 * @description Firebaseã®ç®¡ç†ç”»é¢ã‹ã‚‰å–å¾—ã—ãŸAPIã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @note ç’°å¢ƒå¤‰æ•°ã¯`.env.local`ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©ã—ã¦ã„ã¾ã™
 */
export const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,
  measurementId: process.env.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID,
};

/**
 * @description FirebaseAppã‚’è¿”ã™
 */
export const getFirebaseApp = (): FirebaseApp | undefined => {
  if (typeof window === "undefined") return; // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§å®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹

  return getApps()[0] || initializeApp(firebaseConfig);
};

/**
 * @description FirebaseAuthã‚’è¿”ã™
 */
export const getFirebaseAuth = (): FirebaseAuth => {
  return getAuth(getFirebaseApp());
};

/**
 * @description ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³
 */
export const login = async (email: string, password: string) => {
  // FirebaseAuthã‚’å–å¾—ã™ã‚‹
  const auth = getFirebaseAuth();

  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
  const result = await signInWithEmailAndPassword(auth, email, password);

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ä½œæˆã™ã‚‹ãŸã‚ã®IDã‚’ä½œæˆã™ã‚‹
  const id = await result.user.getIdToken();

  // Cookieã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã™ã‚‹ã‚ˆã†ã«APIã‚’æŠ•ã’ã‚‹
  await fetch("/api/session", { method: "POST", body: JSON.stringify({ id }) });
};

/**
 * @description ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã›ã‚‹
 */
export const logout = async () => {
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³Cookieã‚’å‰Šé™¤ã™ã‚‹ãŸã‚ã€Firebase SDKã§ãªãREST APIã§ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã›ã‚‹
  await fetch("/api/sessionLogout", { method: "POST" });
};
```

å°‘ã—é•·ã„ã§ã™ãŒã€ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã¯`login()`ãƒ»`logout()`ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

ä»Šå›ã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ãŸã‚ã€`login()`å†…ã§`signInWithEmailAndPassword()`ã‚’ä½¿ã£ã¦ã„ã¾ã™ãŒã€ã‚‚ã—ä»–ã®ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•ã‚’ä½¿ã„ãŸã„å ´åˆã¯ã€Firbase SDK ãŒæä¾›ã™ã‚‹åˆ¥ã®é–¢æ•°ãªã©ã‚’ä½¿ã†ã“ã¨ã§å¯¾å¿œã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

:::message
Firebase Authentication ã‚’ä½¿ã†ã«ã¯ã€Firebase ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ç”»é¢ã§è¨­å®šã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚è©³ã—ãã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://firebase.google.com/docs/auth/web/start?hl=ja)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
:::

ã¾ãŸ`logout()`ã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆã§ã‚‚æ›¸ã„ã¦ã‚ã‚‹ã‚ˆã†ã« Cookie ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID ã‚’å‰Šé™¤ã™ã‚‹ãŸã‚ã€Firebase SDK ãŒæä¾›ã™ã‚‹`signOut()`ã§ãªãã€`"/api/sessionLogout"`ã¨ã„ã†ã€ã“ã®å¾Œå®Ÿè£…ã™ã‚‹ API ã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’è¡Œã„ã¾ã™ã€‚

ä¸Šè¨˜ãŒå®Ÿè£…ã§ãã¾ã—ãŸã‚‰ã€æ¬¡ã¯ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ ğŸ¿

# ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®å®Ÿè£…

ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’è¨˜è¿°ã—ã¦ã„ãã¾ã™ãŒã€ç°¡ç•¥åŒ–ã®ãŸã‚ã«ãƒ‡ã‚¶ã‚¤ãƒ³éƒ¨åˆ†ãªã©ã¯æ’é™¤ã—ã¦ã„ã¾ã™ã®ã§ã€ã‚‚ã—ç”»é¢ãŒã‚·ãƒ§ãƒœã‚¤ã¨æ„Ÿã˜ãŸæ–¹ã¯é©æ™‚è‡ªå‰ã§å®Ÿè£…ã—ã¦é ‚ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚

```tsx:./pages/login.tsx
import type { FormEvent } from "react";

import { NextPage } from "next";
import { useState } from "react";
import { useRouter } from "next/router";

import { login } from "../utils";  // ä¸Šè¨˜ã§å®Ÿè£…ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«

const LoginPage: NextPage = () => {
  const router = useRouter();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");

  const onSubmit = async (event: FormEvent) => {
    event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®<form />ã®æŒ™å‹•ã‚’ç„¡åŠ¹ã«ã™ã‚‹
    await login(email, password); // emailãƒ»passwordã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³
ã€€ã€€router.push("/dashboard"); // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã¸é·ç§»ã•ã›ã‚‹
  };

  return (
    <div>
      <h1>ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢</h1>

      <form onSubmit={onSubmit}>
        <div>
          <label htmlFor="email">Email:</label>

          <input
            id="email"
            value={email}
            onInput={(e) => setEmail(e.currentTarget.value)}
          />
        </div>

        <div>
          <label htmlFor="password">Password:</label>

          <input
            id="password"
            type="password"
            value={password}
            onInput={(e) => setPassword(e.currentTarget.value)}
          />
        </div>

        <button type="submit">login</button>
      </form>
    </div>
  );
};

export default LoginPage;
```

ä¸Šè¨˜ã®å®Ÿè£…ã§ã¯ã€ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä½¿ã£ã¦ä¸Šè¨˜ã§å®Ÿè£…ã—ãŸ`login()`ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚ç°¡ç•¥åŒ–ã®ãŸã‚è‰²ã€…ã¨ãƒ„ãƒƒã‚³ãƒŸã©ã“ã‚ã¯ã‚ã‚Šã¾ã™ãŒã€ã”æ„›å¬Œã¨ã„ã†äº‹ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚

ä¸Šè¨˜ã®å®Ÿè£…ãŒã§ãã¾ã—ãŸã‚‰ã€æ¬¡ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã† ğŸ‰

# ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã®å®Ÿè£…

ã“ã‚Œã‹ã‚‰ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ãŒã€ã“ã®ãƒšãƒ¼ã‚¸ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿é–²è¦§ã§ãã‚‹ã‚ˆã†ã«ã—ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ç„¡ã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸(`/login`)ã¸é·ç§»ã•ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã¾ãšã¯ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆéƒ¨åˆ†ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã† ğŸ‘‡

```tsx:./pages/dashboard.tsx
import type { GetServerSideProps, NextPage } from "next";

import nookies from "nookies";
import { useRouter } from "next/router";

import { logout } from "../utils"; // ä¸Šè¨˜ã§å®Ÿè£…ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«
import { firebaseAdmin } from "../firebaseAdmin"; // ã“ã®å¾Œã«å®Ÿè£…ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

const DashboardPage: NextPage<{ email: string }> = ({ email }) => {
  const router = useRouter();

  const onLogout = async () => {
    await logout(); // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã›ã‚‹
    router.push("/login"); // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸é·ç§»ã•ã›ã‚‹
  };

  return (
    <div>
      <h1>Dashboard Pages</h1>

      <h2>email: {email}</h2>

      <button onClick={onLogout}>Logout</button>
    </div>
  );
};

export default DashboardPage;
```

ç‰¹ã«è§£èª¬ã™ã‚‹ã¨ã“ã‚ã¯ç„¡ã„ã¨æ€ã„ã¾ã™ãŒã€ä¸€å¿œãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹äº‹ã‚’ç¢ºã‹ã‚ã‚‹ãŸã‚ã«`email`ã‚’ porps ã‹ã‚‰ã‚‚ã‚‰ã£ã¦è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚

æ¬¡ã¯ã€èªè¨¼å‡¦ç†ã‚’è¡Œã†`getServerSideProps()`ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ ğŸ²

## getServerSideProps()ã®å®Ÿè£…

ä¸Šè¨˜ã§å®Ÿè£…ã—ãŸ`<DashboardPage />`ã®ä¸‹ã«`getServerSideProps()`ã‚’å®Ÿè£…ã—ã¦ã„ãã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ ğŸ‘‡

```tsx:./pages/dashboard.tsx
// ...

const DashboardPage: NextPage<{ email: string }> = ({ email }) => {
  // ...
}

export const getServerSideProps: GetServerSideProps = async (ctx) => {
  const cookies = nookies.get(ctx);
  const session = cookies.session || "";

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’æ¤œè¨¼ã—ã¦ã€èªè¨¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹
  const user = await firebaseAdmin
    .auth()
    .verifySessionCookie(session, true)
    .catch(() => null);

  // èªè¨¼æƒ…å ±ãŒç„¡ã„å ´åˆã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸é·ç§»ã•ã›ã‚‹
  if (!user) {
    return {
      redirect: {
        destination: "/login",
        permanent: false,
      },
    };
  }

  return {
    props: {
      email: user.email,
    },
  };
};

export default DashboardPage;
```

ã‚„ã£ã¦ã„ã‚‹äº‹ã¯ã€`nookies`ã‚’ä½¿ã£ã¦ Cookie ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID ã‚’å–å¾—ã—ã€Firebase Admin SDK ã®`verifySessionCookie()`ã‚’å®Ÿè¡Œã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚æ¤œè¨¼ãŒæˆåŠŸã™ã‚‹ã¨èªè¨¼æƒ…å ±ã‚’å«ã‚“ã å€¤ã‚’è¿”ã‚Šå€¤ã¨ã—ã¦å—ã‘å–ã‚Œã¾ã™ã®ã§ã€ãã‚Œã‚’ä½¿ã£ã¦ãƒšãƒ¼ã‚¸ã®å‡ºã—åˆ†ã‘ã‚’ã—ã¦ã„ã¾ã™ã€‚

æ³¨æ„ç‚¹ã¨ã—ã¦ã€`verifySessionCookie()`ã®**ç¬¬äºŒå¼•æ•°ã«ã¯å¿…ãš`true`ã‚’æ¸¡ã—ã¦ãã ã•ã„ã€‚** ãã†ã—ãªã„ã¨ã€ç„¡åŠ¹ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ ID ã§ã‚‚èªè¨¼æƒ…å ±ã‚’å–å¾—ã§ãã¦ã—ã¾ã„ã¾ã™ã€‚

ã¾ãŸã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†ã®è©³ç´°ã«ã¤ã„ã¦ã¯ä»¥å‰è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸã®ã§ã€ãã¡ã‚‰ã‚’å‚ç…§ã—ã¦é ‚ã‘ã‚‹ã¨å¹¸ã„ã§ã™ ğŸ‘‡

https://zenn.dev/uttk/articles/4649e49f1e6628

ã•ã¦ã€ã“ã‚Œã§ãƒ•ãƒ­ãƒ³ãƒˆéƒ¨åˆ†ã¯å®Ÿè£…ã§ãã¾ã—ãŸã®ã§ã€æ®‹ã‚Šã® API éƒ¨åˆ†ã®å®Ÿè£…ã‚’ã—ã¦ã„ãã¾ã—ã‚‡ã† ğŸ§¸

# API ã®å®Ÿè£…

ã“ã®è¨˜äº‹ã§ã¯ã€Next.js ãŒæä¾›ã—ã¦ã„ã‚‹[API Routes](https://nextjs.org/docs/api-routes/introduction)ã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚ã‚‚ã—ã“ã®æ©Ÿèƒ½ã‚’ä½¿ã‚ãšã«å®Ÿè£…ã—ãŸã„å ´åˆã¯ã€é©æ™‚å¯¾å¿œã—ã¦å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

## firebase-admin ã®åˆæœŸåŒ–

ã¾ãšã¯ã€Firebase Admin SDK ã‚’åˆæœŸåŒ–ã™ã‚‹ãŸã‚ã®å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ ğŸ‘‡

```ts:./firebaseAdmin.ts
import admin from "firebase-admin";

/**
 * @description Firebaseã®ç®¡ç†ç”»é¢ã‹ã‚‰å–å¾—ã—ãŸç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±
 * @note ç’°å¢ƒå¤‰æ•°ã¯`.env.local`ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©ã—ã¦ã„ã¾ã™
 */
const serviceAccount: admin.ServiceAccount = {
  projectId: process.env.FIREBASE_ADMIN_PROJECT_ID,
  clientEmail: process.env.FIREBASE_ADMIN_CLIENT_EMAIL,
  privateKey: (process.env.FIREBASE_ADMIN_PRIVATE_KEY || "").replace(
    /\\n/g,
    "\n"
  ),
};

/**
 * @description Firebase Admin SDKã‚’æ‰±ã†ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @note ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã¿ã§ä½¿ç”¨å¯èƒ½
 */
export const firebaseAdmin =
  admin.apps[0] ||
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
  });
```

åˆæœŸåŒ–ã™ã‚‹ã ã‘ãªã®ã§ç‰¹ã«é›£ã—ã„äº‹ã¯ã—ã¦ã„ã¾ã›ã‚“ãŒã€`serviceAccount`ã®æƒ…å ±ã¯ Firebase ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ç”»é¢ã‹ã‚‰å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹äº‹ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼

è©³ã—ã„ã“ã¨ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¼‰ã£ã¦ã„ã¾ã™ã®ã§ã€ã”å‚ç…§ãã ã•ã„ ğŸ‘‡

https://firebase.google.com/docs/admin/setup?hl=ja#initialize-sdk

## /api/session ã®å®Ÿè£…

:::message
æœ¬æ¥ã§ã‚ã‚Œã°[CSRF](https://developer.mozilla.org/ja/docs/Glossary/CSRF)å¯¾ç­–ãªã©ã‚’ã™ã‚‹ã¹ãã§ã™ãŒã€ä»Šå›ã¯ç°¡ç•¥åŒ–ã®ãŸã‚ã«å®Ÿè£…ã—ã¦ã„ã¾ã›ã‚“ã€‚äºˆã‚ã”äº†æ‰¿ä¸‹ã•ã„ ğŸ™‡â€â™‚ï¸
:::

æ¬¡ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ ğŸ‘‡

```ts:./pages/api/session.ts
import type { NextApiRequest as Req, NextApiResponse as Res } from "next";

import { setCookie } from "nookies";
import { firebaseAdmin } from "../../firebaseAdmin"; // ä¸Šè¨˜ã§å®Ÿè£…ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«

export default async function sessionApi(req: Req, res: Res) {
  // "POST"ä»¥å¤–ã¯ã€"404 Not Found"ã‚’è¿”ã™
  if (req.method !== "POST") return res.status(404).send("Not Found");

  const auth = firebaseAdmin.auth();

  // Tokenã®æœ‰åŠ¹æœŸé™
  const expiresIn = 60 * 60 * 24 * 5 * 1000; // 5æ—¥

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³Cookieã‚’ä½œæˆã™ã‚‹ãŸã‚ã®IDã‚’å–å¾—
  const id = (JSON.parse(req.body).id || "").toString();

  // Cookieã«ä¿å­˜ã™ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ä½œæˆã™ã‚‹
  const sessionCookie = await auth.createSessionCookie(id, { expiresIn });

  // Cookieã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
  const options = {
    maxAge: expiresIn,
    httpOnly: true,
    secure: true,
    path: "/",
  };

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’Cookieã«è¨­å®šã™ã‚‹
  setCookie({ res }, "session", sessionCookie, options);

  res.send(JSON.stringify({ status: "success" }));
}
```

ä¸Šè¨˜ã®å®Ÿè£…ã¯ã€`createSessionCookie()`ã‚’ä½¿ã£ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID ã‚’ä½œæˆã—ã€ãã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID ã‚’ Cookie ã«ä¿å­˜ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã ã‘ãªã®ã§ã€ã‚„ã£ã¦ã„ã‚‹äº‹ã¯ç°¡å˜ã§ã™ã­ã€‚

æ³¨æ„ç‚¹ã¨ã—ã¦ã¯ã€Cookie ã®`path`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã¡ã‚ƒã‚“ã¨è¨­å®šã—ãªã„ã¨ä¸Šæ‰‹ãå‡¦ç†ãŒã§ããªã„ã®ã§ã€é©åˆ‡ãªå€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚ä»Šå›ã¯ã‚µãƒ¼ãƒ“ã‚¹å…¨ä½“ã§æ‰±ãˆã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

Cookie ã®ä»•æ§˜ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆãŒå‚è€ƒã«ãªã‚‹ã¨æ€ã„ã¾ã™ ğŸ‘‡

https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies

## /api/sessionLogout ã®å®Ÿè£…

æ¬¡ã¯ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’è¡Œã†`/api/sessionLogout`ã‚’å®Ÿè£…ã—ã¾ã™ ğŸ‘‡

```ts:./pages/api/sessionLogout.ts
import type { NextApiRequest as Req, NextApiResponse as Res } from "next";

import { parseCookies, destroyCookie } from "nookies";
import { firebaseAdmin } from "../../firebaseAdmin";

export default async function sessionLogoutApi(req: Req, res: Res) {
  // POSTã˜ã‚ƒãªã‘ã‚Œã°ã€"404 Not Found"ã‚’è¿”ã™
  if (req.method !== "POST") return res.status(404).send("Not Found");

  const auth = firebaseAdmin.auth();

  // Cookieã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å–å¾—ã™ã‚‹
  const sessionId = parseCookies({ req }).session || "";

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹
  const decodedClaims = await auth
    .verifySessionCookie(sessionId)
    .catch(() => null)

  // å…¨ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹ã«ã™ã‚‹
  if (decodedClaims) {
    await auth.revokeRefreshTokens(decodedClaims.sub);
  }

  // Cookieã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å‰Šé™¤
  destroyCookie({ res }, "session", { path: "/" });

  res.send(JSON.stringify({ status: "success" }));
}
```

ä¸Šè¨˜ã®å‡¦ç†ã¯ã€`verifySessionCookie()`ã‚’ä½¿ã£ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—ã—ã€ãã®æƒ…å ±ã‚’`revokeRefreshTokens()`ã«æ¸¡ã—ã¦ã€æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID( Cookie ã«ä¿å­˜ã—ã¦ã„ãŸå€¤ )ã‚’ç„¡åŠ¹ã«ã—ã¦ã„ã¾ã™ã€‚

`revokeRefreshTokens()`ã‚’ä½¿ã†ã¨ã€**ã™ã¹ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå–ã‚Šæ¶ˆã•ã‚Œã‚‹**ãŸã‚ã€ä»–ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§æ–°ãŸã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹å¿…è¦ãŒå‡ºã¦ãã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚æ©Ÿå¯†æ€§ã®é«˜ã„æƒ…å ±ã‚’æ‰±ã†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å ´åˆã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé–“ã‚’çŸ­ãã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚

# å®Ÿè£…å®Œäº† âœ¨

ã¯ã„ã€ä»¥ä¸Šã§å®Ÿè£…ã¯çµ‚äº†ã§ã™ï¼

ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã¿ã¦ã€ã¡ã‚ƒã‚“ã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã‹ç¢ºèªã§ãã¦ã„ã‚Œã°å•é¡Œã‚ã‚Šã¾ã›ã‚“ï¼

ãŠç–²ã‚Œã•ã¾ã§ã—ãŸ ğŸ™Œ

# ãŠã¾ã‘: getInitialProps ã§å®Ÿè£…ã™ã‚‹

ä¸Šè¨˜ã®å®Ÿè£…ã§ã‚‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãŒå‡ºæ¥ã¦ã„ã¾ã™ãŒã€`getServerSideProps()`ã¯ãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºãŒé…ããªã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’ä¸Šã’ãŸã„ãªã‚‰`getInitialProps()`ã‚’ä½¿ã£ãŸæ–¹ãŒè‰¯ã„ã§ã™ã€‚

ãªã®ã§ã€`getInitialProps()`ã‚’ä½¿ã£ãŸç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«ã‚’ãŠã¾ã‘ã¨ã—ã¦æ®‹ã—ã¦ãŠãã¾ã™ã®ã§ã€å‚è€ƒã«ã—ã¦ãã ã•ã„ ğŸ‘‡

```ts:./pages/api/me.ts
import type { NextApiRequest as Req, NextApiResponse as Res } from "next";

import { parseCookies } from "nookies";
import { firebaseAdmin } from "../../firebaseAdmin";

export default async function meApi(req: Req, res: Res) {
  // Cookieã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å–å¾—ã™ã‚‹
  const sessionId = parseCookies({ req }).session;

  if (req.method !== "GET") return res.status(404).send("Not Found");
  if (!sessionId) return res.json({});

  const auth = firebaseAdmin.auth();

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹
  const user = await auth
    .verifySessionCookie(sessionId, true)
    .catch(() => null);

  res.json(user ? { user: { email: user.email } } : {});
}
```

```tsx:./pages/dashboard.tsx
import type { NextPage } from "next";
import Router, { useRouter } from "next/router";
import { logout } from "../utils";

const DashboardPage: NextPage<{ email: string }> = ({ email }) => {
  // ä¸Šè¨˜ã¨åŒã˜å®Ÿè£…
};

DashboardPage.getInitialProps = async ({ req, res }) => {
  const isServerSide = typeof window === "undefined";

  // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã¿ã§å‹•ã‹ã™
  if (isServerSide && req && res) {
    const root = "http://localhost:3000";
    const options = { headers: { cookie: req.headers.cookie || "" } };

    const result = await fetch(`${root}/api/me`, options);
    const json = (await result.json()) as { user?: { email: string } };

    // èªè¨¼æƒ…å ±ãŒç„¡ã‘ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã‚‹
    if (!json.user) {
      res.writeHead(302, { Location: "/login" });
      res.end();
    }

    return { email: (json.user || {}).email || "" };
  }

  // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã¿ã§å‹•ã‹ã™
  if (!isServerSide) {
    const result = await fetch("/api/me"); // èªè¨¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹
    const json = (await result.json()) as { user?: { email: string } };

    // èªè¨¼æƒ…å ±ãŒç„¡ã‘ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã‚‹
    if (!json.user) Router.push("/login");

    return { email: (json.user || {}).email || "" };
  }

  return { email: "" };
};

export default DashboardPage;
```

# ã‚ã¨ãŒã

ã“ã“ã¾ã§èª­ã‚“ã§ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ ğŸ™

Next.js ã¨ Firebase ã‚’ä½¿ã£ã¦èªè¨¼å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã—ãŸãŒã€æ„å¤–ã¨ç°¡å˜ã«å®Ÿè£…ã§ãã‚‹ã¨æ€ã†ã®ã§ã€Firebase ã‚’ä½¿ã£ã¦ã„ã‚‹æ–¹ã¯ãœã²å‚è€ƒã«ã—ã¦ä¸‹ã•ã„ï¼

ã¾ãŸå€‹äººçš„ã«ã¯ã€Firebase SDK ãŒ[Tree Shaking](https://developer.mozilla.org/ja/docs/Glossary/Tree_shaking)ã«å¯¾å¿œã—ãŸã®ã§ã€ãã‚Œã‚’è©¦ã—ã¦ã¿ã‚‹ã®ãŒç›®çš„ã¨ã—ã¦ã‚ã‚Šã¾ã—ãŸã€‚é–¢æ•°å‹ã£ã½ãå®Ÿè£…ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã€å€‹äººçš„ã«ã¯æ›¸ãã‚„ã™ããªã£ãŸå°è±¡ã§ã—ãŸã€‚ä»Šã®ã†ã¡ã«è§¦ã£ã¦æ…£ã‚Œã¦ãŠããŸã„ã§ã™ã­ ğŸ’ª

è¨˜äº‹ã«é–“é•ã„ãªã©ãŒã‚ã‚Œã°ã€ã‚³ãƒ¡ãƒ³ãƒˆãªã©ã§æ•™ãˆã¦é ‚ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚
ã“ã‚ŒãŒèª°ã‹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

ãã‚Œã§ã¯ã¾ãŸ ğŸ‘‹
